<?php
/**
 * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä Excel-–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
 */

use PhpOffice\PhpSpreadsheet\IOFactory;
use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Worksheet\Worksheet;
use PhpOffice\PhpSpreadsheet\Worksheet\Drawing;
use PhpOffice\PhpSpreadsheet\Style\Border;
use PhpOffice\PhpSpreadsheet\Style\Alignment;
use PhpOffice\PhpSpreadsheet\Style\Fill;
use Bitrix\Main\Web\HttpClient;

require_once $_SERVER['DOCUMENT_ROOT'] . '/local/php_interface/lib/PhpSpreadsheet/vendor/autoload.php';

class ExcelGenerator {

    private Spreadsheet $spreadsheet;
    private Worksheet $sheet;
    private array $priceTypeNames;
    private array $tempProductsData = []; // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞

    public function __construct() {
        if (!file_exists(TEMPLATE_XLSX)) {
            throw new Exception('–®–∞–±–ª–æ–Ω Excel –Ω–µ –Ω–∞–π–¥–µ–Ω: ' . TEMPLATE_XLSX);
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω
        $reader = IOFactory::createReader('Xlsx');
        $this->spreadsheet = $reader->load(TEMPLATE_XLSX);
        $this->sheet = $this->spreadsheet->getActiveSheet();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–æ–≤ —Ü–µ–Ω
        $priceConfig = require __DIR__ . '/../config/price_types.php';
        $this->priceTypeNames = $priceConfig['ids_to_names'];

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
        $this->sheet->getColumnDimension('B')->setWidth(26);
        $this->sheet->getColumnDimension('C')->setWidth(45);
    }

    // === –î–æ–±–∞–≤–ª–µ–Ω–æ: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ –≤ —à–∞–±–ª–æ–Ω–µ Excel (#DATE#, #MANAGER_NAME# –∏ —Ç.–ø.)
    private function replacePlaceholders(\PhpOffice\PhpSpreadsheet\Spreadsheet $spreadsheet, array $map): void {
        foreach ($spreadsheet->getWorksheetIterator() as $ws) {
            foreach ($ws->getCellCollection() as $addr) {
                $cell = $ws->getCell($addr);
                $val  = $cell->getValue();

                if (is_string($val)) {
                    $new = strtr($val, $map);
                    if ($new !== $val) {
                        $cell->setValue($new);
                    }
                    continue;
                }
                if ($val instanceof \PhpOffice\PhpSpreadsheet\RichText\RichText) {
                    foreach ($val->getRichTextElements() as $el) {
                        $t  = $el->getText();
                        $nt = strtr($t, $map);
                        if ($nt !== $t) {
                            $el->setText($nt);
                        }
                    }
                    $cell->setValue($val);
                }
            }
        }
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Excel-—Ñ–∞–π–ª
     */
    public function generate(array $productsData, array $kpInfo): void {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        $kpInfo = fillKpInfoDefaults(is_array($kpInfo) ? $kpInfo : []);

        // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ —à–∞–±–ª–æ–Ω–∞–º–∏ (–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã)
        $this->replacePlaceholders($this->spreadsheet, [
            '#DATE#'             => (string)($kpInfo['date'] ?? date('d.m.Y')),
            '#CUSTOMER#'         => (string)($kpInfo['customer'] ?? ''),
            '#OBJECT#'           => (string)($kpInfo['object'] ?? ''),
            '#MANAGER_NAME#'     => (string)($kpInfo['manager'] ?? ''),
            '#MANAGER_POSITION#' => (string)($kpInfo['position'] ?? ''),
            '#MANAGER_EMAIL#'    => (string)($kpInfo['email'] ?? ''),
            '#MANAGER_PHONE#'    => (string)($kpInfo['phone'] ?? ''),
            '#MANAGER_COMPANY#'  => (string)($kpInfo['company'] ?? ''),
            '#COMMENT#'          => (string)($kpInfo['comment'] ?? ''),
        ]);

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —à–∞–ø–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã ‚Äî –ø–æ —è—á–µ–π–∫–∞–º)
        $this->fillHeader($kpInfo);

        // –ù–∞—Ö–æ–¥–∏–º –Ω–∞—á–∞–ª–æ —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤
        $headerRow = $this->findProductTableHeader();

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–æ–≤–∞—Ä—ã
        $lastRow = $this->fillProducts($productsData, $headerRow, $kpInfo);

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É—Ç–µ—Ä —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏
        $this->fillFooter($lastRow + 2);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ—Ç–¥–∞—ë–º —Ñ–∞–π–ª
        $this->save($kpInfo);
    }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç —à–∞–ø–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞
     */
    private function fillHeader(array $kpInfo): void {
        // –î–∞—Ç–∞, –∑–∞–∫–∞–∑—á–∏–∫, –æ–±—ä–µ–∫—Ç ‚Äî –≤ –∫–æ–ª–æ–Ω–∫–µ C
        $this->sheet->setCellValue('C4', (string)($kpInfo['date'] ?? date('d.m.Y')));
        $this->sheet->setCellValue('C5', (string)($kpInfo['customer'] ?? ''));
        $this->sheet->setCellValue('C6', (string)($kpInfo['object'] ?? ''));

        // –ú–µ–Ω–µ–¥–∂–µ—Ä, —Ç–µ–ª–µ—Ñ–æ–Ω, –ø–æ—á—Ç–∞ ‚Äî –≤ –∫–æ–ª–æ–Ω–∫–µ G (–∑–Ω–∞—á–µ–Ω–∏—è)
        $managerLines = array_values(array_filter([
            (string)($kpInfo['manager'] ?? ''),
            (string)($kpInfo['position'] ?? ''),
            (string)($kpInfo['company'] ?? ''),
        ], function($value) {
            return $value !== '';
        }));

        $this->sheet->setCellValue('G4', $managerLines ? implode("\n", $managerLines) : '');
        $this->sheet->setCellValue('G5', (string)($kpInfo['phone'] ?? ''));
        $this->sheet->setCellValue('G6', (string)($kpInfo['email'] ?? ''));

        // –ú–µ—Ç–∫–∏ ‚Äî –≤ D (–æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã —Å F)
        $this->sheet->setCellValue('D4', '–ú–µ–Ω–µ–¥–∂–µ—Ä:');
        $this->sheet->setCellValue('D5', '–¢–µ–ª–µ—Ñ–æ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä–∞:');
        $this->sheet->setCellValue('D6', '–ü–æ—á—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞:');

        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –º–µ—Ç–∫–∏
        $this->sheet->mergeCells('D4:F4');
        $this->sheet->mergeCells('D5:F5');
        $this->sheet->mergeCells('D6:F6');

        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
        $this->sheet->mergeCells('G4:H4');
        $this->sheet->mergeCells('G5:H5');
        $this->sheet->mergeCells('G6:H6');

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —è—á–µ–µ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏
        foreach (['C4', 'C5', 'C6', 'G4', 'G5', 'G6'] as $addr) {
            $style = $this->sheet->getStyle($addr);
            $style->getFont()->setName('Arial')->setSize(9)->setBold(false);
            $style->getAlignment()
                ->setHorizontal(Alignment::HORIZONTAL_LEFT)
                ->setVertical(Alignment::VERTICAL_CENTER)
                ->setWrapText(true);
        }
    }

    /**
     * –ù–∞—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤
     */
    private function findProductTableHeader(): int {
        // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏: "‚Ññ | –§–æ—Ç–æ | –¢–æ–≤–∞—Ä –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–≤–∞—Ä–∞ | –ö–æ–ª-–≤–æ —à—Ç | –¶–µ–Ω–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏ | –°–∫–∏–¥–∫–∞ | –í–∞—à–∞ —Ü–µ–Ω–∞ | –°—É–º–º–∞, —Ä—É–±."
        for ($row = 1; $row <= 50; $row++) {
            $cellValue = (string)$this->sheet->getCell("C{$row}")->getValue();
            if (stripos($cellValue, '–¢–æ–≤–∞—Ä –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–≤–∞—Ä–∞') !== false) {
                return $row;
            }
        }

        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫—É 8 (–µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏)
        return 8;
    }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ç–æ–≤–∞—Ä—ã
     */
    private function fillProducts(array $productsData, int $headerRow, array $kpInfo): int {
        $this->tempProductsData = $productsData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ fillTotals

        $firstDataRow = $headerRow + 1;
        $nProducts = count($productsData);
        $totalWithoutDiscount = 0.0;
        $totalWithDiscount = 0.0;

        foreach ($productsData as $i => $product) {
            // –ö–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –∑–∞–Ω–∏–º–∞–µ—Ç 2 —Å—Ç—Ä–æ–∫–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ + –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
            $row = $firstDataRow + ($i * 2);

            // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
            $name = str_replace('¬∞', '', (string)($product['name'] ?? ''));
            $article = (string)($product['article'] ?? '');
            $measure = (string)($product['measure'] ?? '—à—Ç');
            $quantity = max(1, (int)($product['quantity'] ?? 1));

            // –¶–µ–Ω—ã
            $priceWithoutDiscount = (float)($product['price_without_discount'] ?? 0);
            $yourPrice = (float)($product['your_price'] ?? $priceWithoutDiscount); // –ï—Å–ª–∏ –≤–∞—à–∞ —Ü–µ–Ω–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É –±–µ–∑ —Å–∫–∏–¥–∫–∏

            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏
            if ($priceWithoutDiscount != 0) {
                $discountPercent = round((($priceWithoutDiscount - $yourPrice) / $priceWithoutDiscount) * 100, 2);
            } else {
                $discountPercent = 0.0;
            }

            $sum = $quantity * $yourPrice; // –°—É–º–º–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ "–≤–∞—à–µ–π —Ü–µ–Ω–µ"
            $totalWithoutDiscount += $quantity * $priceWithoutDiscount;
            $totalWithDiscount += $sum;

            $imageUrl = (string)($product['image'] ?? '');
            $priceTypeId = (int)($product['price_type_id'] ?? DEFAULT_PRICE_TYPE_ID);
            $priceTypeName = $this->priceTypeNames[$priceTypeId] ?? '';
            $props = is_array($product['props'] ?? null) ? $product['props'] : [];
            $url = (string)($product['url'] ?? '');

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —è—á–µ–π–∫–∏
            $this->fillProductRow($row, $i + 1, $name, $article, $measure, $quantity, $priceWithoutDiscount, $discountPercent, $yourPrice, $sum, $imageUrl, $priceTypeName, $props, $url);
        }

        // –ò—Ç–æ–≥–∏ ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ–∫—Ü–∏—é –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
        $totalRow = $firstDataRow + ($nProducts * 2);
        $this->fillTotals($totalRow, $totalWithoutDiscount, $totalWithDiscount);

        // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        $commentRow = $totalRow + 2;
        $this->fillComment($commentRow, $kpInfo);

        return $commentRow + 2; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
    }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–∞
     */
    private function fillProductRow(
        int $row,
        int $index,
        string $name,
        string $article,
        string $measure,
        int $quantity,
        float $priceWithoutDiscount,
        float $discountPercent,
        float $yourPrice,
        float $sum,
        string $imageUrl,
        string $priceTypeName,
        array $props,
        string $url
    ): void {
        $paramsRow = $row + 1;

        // A - –ù–æ–º–µ—Ä
        $this->sheet->setCellValue("A{$row}", $index);
        $this->sheet->mergeCells("A{$row}:A{$paramsRow}");

        // B - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if ($imageUrl !== '') {
            $this->insertImage($imageUrl, "B{$row}", $index);
        }
        $this->sheet->mergeCells("B{$row}:B{$paramsRow}");

        // C - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–∂–∏—Ä–Ω–æ–µ, —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–µ, –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–µ)
        $nameCell = "C{$row}";
        $this->sheet->setCellValue($nameCell, $name);
        $nameStyle = $this->sheet->getStyle($nameCell);
        $nameStyle->getFont()->setBold(true)->setSize(10)->setUnderline(true)->getColor()->setARGB('FF722e85');
        $nameStyle->getAlignment()
            ->setHorizontal(Alignment::HORIZONTAL_LEFT)
            ->setVertical(Alignment::VERTICAL_CENTER)
            ->setWrapText(true);

        if ($url !== '') {
            $this->sheet->getCell($nameCell)->getHyperlink()->setUrl($url);
        }

        // C(—Å–ª–µ–¥.—Å—Ç—Ä–æ–∫–∞) - –ê—Ä—Ç–∏–∫—É–ª –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        $paramsText = "–ê—Ä—Ç–∏–∫—É–ª: {$article}\n\n–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:\n";
        $paramsList = [
            '–¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –ö' => str_replace('¬∞', '', (string)($props['ct'] ?? '')),
            '–≠–ª–µ–∫—Ç—Ä–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –í—Ç' => str_replace('¬∞', '', (string)($props['pwr'] ?? '')),
            '–°—Ç–µ–ø–µ–Ω—å –ø—ã–ª–µ–≤–ª–∞–≥–æ–∑–∞—â–∏—Ç—ã' => str_replace('¬∞', '', (string)($props['ip'] ?? '')),
            '–ò–Ω–¥–µ–∫—Å —Ü–≤–µ—Ç–æ–ø–µ—Ä–µ–¥–∞—á–∏, Ra' => str_replace('¬∞', '', (string)($props['cri'] ?? '')),
        ];

        if ($priceTypeName !== '') {
            $paramsList['–¢–∏–ø —Ü–µ–Ω—ã'] = $priceTypeName;
        }

        foreach ($paramsList as $label => $value) {
            $paramsText .= $label . ': ' . ($value !== '' ? $value : '‚Äî') . "\n";
        }

        $paramsCell = "C{$paramsRow}";
        $this->sheet->setCellValue($paramsCell, trim($paramsText));
        $paramsStyle = $this->sheet->getStyle($paramsCell);
        $paramsStyle->getFont()->setSize(10)->setBold(false);
        $paramsStyle->getAlignment()
            ->setHorizontal(Alignment::HORIZONTAL_LEFT)
            ->setVertical(Alignment::VERTICAL_TOP)
            ->setWrapText(true);

        // –û–±—ä–µ–¥–∏–Ω—è–µ–º C..D
        $this->sheet->mergeCells("C{$paramsRow}:D{$paramsRow}");

        // D - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
        $this->sheet->setCellValue("D{$row}", $quantity . ' ' . $measure);
        $this->sheet->mergeCells("D{$row}:D{$paramsRow}");

        // E - –¶–µ–Ω–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏
        $this->sheet->setCellValue("E{$row}", $priceWithoutDiscount);
        $this->sheet->getStyle("E{$row}")->getNumberFormat()->setFormatCode('#,##0.00');
        $this->sheet->mergeCells("E{$row}:E{$paramsRow}");

        // F - –°–∫–∏–¥–∫–∞
        $this->sheet->setCellValue("F{$row}", $discountPercent . '%');
        $this->sheet->mergeCells("F{$row}:F{$paramsRow}");

        // G - –í–∞—à–∞ —Ü–µ–Ω–∞
        $this->sheet->setCellValue("G{$row}", $yourPrice);
        $this->sheet->getStyle("G{$row}")->getNumberFormat()->setFormatCode('#,##0.00');
        $this->sheet->mergeCells("G{$row}:G{$paramsRow}");

        // H - –°—É–º–º–∞
        $this->sheet->setCellValue("H{$row}", $sum);
        $this->sheet->getStyle("H{$row}")->getNumberFormat()->setFormatCode('#,##0.00');
        $this->sheet->mergeCells("H{$row}:H{$paramsRow}");

        // –í—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫
        $nameLines = max(1, ceil(mb_strlen($name) / 50));
        $this->sheet->getRowDimension($row)->setRowHeight($nameLines * 20);
        $this->sheet->getRowDimension($paramsRow)->setRowHeight(140);

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–π
        $borderStyle = [
            'borders' => [
                'allBorders' => [
                    'borderStyle' => Border::BORDER_THIN,
                    'color' => ['argb' => 'FF000000'],
                ],
            ],
        ];
        $this->sheet->getStyle("A{$row}:H{$paramsRow}")->applyFromArray($borderStyle);
    }

    /**
     * –í—Å—Ç–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
     */
    private function insertImage(string $imageUrl, string $cell, int $index): void {
        try {
            $client = new HttpClient(['timeout' => 5, 'streamTimeout' => 5]);
            if ($client->get($imageUrl)) {
                $bin = $client->getResult();
                $ct = (string)$client->getHeaders()->get('Content-Type');

                $ext = 'jpg';
                if (preg_match('~image/(jpe?g|png|gif|webp)~i', $ct, $m)) {
                    $ext = strtolower($m[1]);
                    if ($ext === 'jpeg') $ext = 'jpg';
                }

                if (!file_exists(TEMP_DIR)) {
                    @mkdir(TEMP_DIR, 0755, true);
                }

                $imgPath = TEMP_DIR . 'img_' . $index . '.' . $ext;
                file_put_contents($imgPath, $bin);

                $drawing = new Drawing();
                $drawing->setPath($imgPath);
                $drawing->setCoordinates($cell);
                $drawing->setHeight(180);
                $drawing->setOffsetX(5);
                $drawing->setOffsetY(5);
                $drawing->setWorksheet($this->sheet);
            }
        } catch (\Throwable $e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        }
    }

    /**
     * –ù–∞—Ö–æ–¥–∏—Ç —Å–µ–∫—Ü–∏—é —Å –∏—Ç–æ–≥–∞–º–∏ –≤ —à–∞–±–ª–æ–Ω–µ
     */
    private function findTotalsSection(): ?int {
        // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å —Ç–µ–∫—Å—Ç–æ–º "–ò–¢–û–ì–ò:"
        for ($row = 1; $row <= 100; $row++) {
            for ($col = 'A'; $col <= 'H'; $col++) {
                $cellValue = (string)$this->sheet->getCell("{$col}{$row}")->getValue();
                if (stripos($cellValue, '–ò–¢–û–ì–ò') !== false) {
                    return $row;
                }
            }
        }
        return null;
    }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∏—Ç–æ–≥–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–µ–∫—Ü–∏–∏ —à–∞–±–ª–æ–Ω–∞
     */
    private function fillTotals(int $afterProductsRow, float $totalWithoutDiscount, float $totalWithDiscount): void {
        $economy = $totalWithoutDiscount - $totalWithDiscount;
        $nds = $totalWithDiscount * 20 / 120;

        // –ò—â–µ–º —Å–µ–∫—Ü–∏—é –∏—Ç–æ–≥–æ–≤ –≤ —à–∞–±–ª–æ–Ω–µ
        $totalsRow = $this->findTotalsSection();

        if ($totalsRow === null) {
            // –ï—Å–ª–∏ —Å–µ–∫—Ü–∏–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞—ë–º –ø—Ä–æ—Å—Ç—É—é
            $row = $afterProductsRow;
            $this->sheet->setCellValue("C{$row}", '–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:');
            $this->sheet->setCellValue("D{$row}", count($this->getTempProductsData()));
            $this->sheet->mergeCells("D{$row}:H{$row}");
            $row++;
            $this->sheet->setCellValue("C{$row}", '–°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏:');
            $this->sheet->setCellValue("D{$row}", $totalWithoutDiscount);
            $this->sheet->getStyle("D{$row}")->getNumberFormat()->setFormatCode('#,##0.00');
            $this->sheet->mergeCells("D{$row}:H{$row}");
            $row++;
            $this->sheet->setCellValue("C{$row}", 'üëâ –í–´ –≠–ö–û–ù–û–ú–ò–¢–ï:');
            if ($totalWithoutDiscount != 0) {
                $economyText = number_format($economy, 0, '.', ' ') . ' —Ä—É–± (' . round($economy / $totalWithoutDiscount * 100, 0) . '%)';
            } else {
                $economyText = number_format($economy, 0, '.', ' ') . ' —Ä—É–± (0%)';
            }
            $this->sheet->setCellValue("D{$row}", $economyText);
            $this->sheet->mergeCells("D{$row}:H{$row}");
            $row++;
            $this->sheet->setCellValue("C{$row}", '–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:');
            $totalWithDiscountText = number_format($totalWithDiscount, 0, '.', ' ') . ' —Ä—É–±‚úÖ';
            $this->sheet->setCellValue("D{$row}", $totalWithDiscountText);
            $this->sheet->mergeCells("D{$row}:H{$row}");
            $row++;
            $this->sheet->setCellValue("C{$row}", '–í —Ç–æ–º —á–∏—Å–ª–µ –ù–î–° 20%');
            $ndsText = number_format($nds, 0, '.', ' ') . ' —Ä—É–±';
            $this->sheet->setCellValue("D{$row}", $ndsText);
            $this->sheet->mergeCells("D{$row}:H{$row}");
            return;
        }

        // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Å–µ–∫—Ü–∏—é –±–ª–∏–∂–µ –∫ —Ç–æ–≤–∞—Ä–∞–º
        $targetRow = $afterProductsRow;
        if ($totalsRow < $targetRow) {
            // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω–∞ –º–µ—Å—Ç–µ
            $targetRow = $totalsRow;
        }

        // –ò—â–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–ª—è –≤ —Å–µ–∫—Ü–∏–∏ –∏—Ç–æ–≥–æ–≤
        for ($row = $targetRow; $row <= $targetRow + 20; $row++) {
            for ($col = 'A'; $col <= 'H'; $col++) {
                $cellValue = (string)$this->sheet->getCell("{$col}{$row}")->getValue();

                // –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
                if (stripos($cellValue, '–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤') !== false && stripos($cellValue, ':') !== false) {
                    $valueCol = chr(ord($col) + 1);
                    if ($valueCol <= 'H') {
                        $this->sheet->setCellValue("{$valueCol}{$row}", count($this->getTempProductsData()));
                        $this->sheet->mergeCells("{$valueCol}{$row}:H{$row}");
                    }
                }

                // –°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏
                if (stripos($cellValue, '–°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏') !== false) {
                    $valueCol = chr(ord($col) + 1);
                    if ($valueCol <= 'H') {
                        $this->sheet->setCellValue("{$valueCol}{$row}", $totalWithoutDiscount);
                        $this->sheet->getStyle("{$valueCol}{$row}")->getNumberFormat()->setFormatCode('#,##0.00');
                        $this->sheet->mergeCells("{$valueCol}{$row}:H{$row}");
                    }
                }

                // –í—ã —ç–∫–æ–Ω–æ–º–∏—Ç–µ
                if (stripos($cellValue, '–≠–ö–û–ù–û–ú–ò–¢–ï') !== false || stripos($cellValue, '—ç–∫–æ–Ω–æ–º–∏—Ç–µ') !== false) {
                    $valueCol = chr(ord($col) + 1);
                    if ($valueCol <= 'H') {
                        if ($totalWithoutDiscount != 0) {
                            $economyText = number_format($economy, 0, '.', ' ') . ' —Ä—É–± (' . round($economy / $totalWithoutDiscount * 100, 0) . '%)';
                        } else {
                            $economyText = number_format($economy, 0, '.', ' ') . ' —Ä—É–± (0%)';
                        }
                        $this->sheet->setCellValue("{$valueCol}{$row}", $economyText);
                        $this->sheet->mergeCells("{$valueCol}{$row}:H{$row}");
                    }
                }

                // –ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ
                if (stripos($cellValue, '–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ') !== false) {
                    $valueCol = chr(ord($col) + 1);
                    if ($valueCol <= 'H') {
                        $totalWithDiscountText = number_format($totalWithDiscount, 0, '.', ' ') . ' —Ä—É–±‚úÖ';
                        $this->sheet->setCellValue("{$valueCol}{$row}", $totalWithDiscountText);
                        $this->sheet->mergeCells("{$valueCol}{$row}:H{$row}");
                    }
                }

                // –ù–î–° 20%
                if (stripos($cellValue, '–ù–î–°') !== false && stripos($cellValue, '20') !== false) {
                    $valueCol = chr(ord($col) + 1);
                    if ($valueCol <= 'H') {
                        $ndsText = number_format($nds, 0, '.', ' ') . ' —Ä—É–±';
                        $this->sheet->setCellValue("{$valueCol}{$row}", $ndsText);
                        $this->sheet->mergeCells("{$valueCol}{$row}:H{$row}");
                    }
                }
            }
        }
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö
     */
    private function getTempProductsData(): array {
        return $this->tempProductsData;
    }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
     */
    private function fillComment(int $row, array $kpInfo): void {
        $commentText = trim((string)($kpInfo['comment'] ?? ''));

        if ($commentText === '') {
            return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        }

        $commentCell = "A{$row}";
        $baseComment = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:';
        $fullText = $baseComment . "\n" . $commentText;

        $this->sheet->setCellValue($commentCell, $fullText);
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º A..H –Ω–∞ 3 —Å—Ç—Ä–æ–∫–∏
        $this->sheet->mergeCells("A{$row}:H" . ($row + 2));

        $style = $this->sheet->getStyle($commentCell);
        $style->getFont()->setSize(9);
        $style->getAlignment()
            ->setHorizontal(Alignment::HORIZONTAL_LEFT)
            ->setVertical(Alignment::VERTICAL_TOP)
            ->setWrapText(true);

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
        $lineCount = substr_count($fullText, "\n") + 1;
        $avgCharsPerLine = 100;

        foreach (explode("\n", $fullText) as $line) {
            if (mb_strlen($line) > $avgCharsPerLine) {
                $lineCount += floor(mb_strlen($line) / $avgCharsPerLine);
            }
        }

        $rowHeight = max(30, $lineCount * 15);
        $this->sheet->getRowDimension($row)->setRowHeight($rowHeight);
        $this->sheet->getRowDimension($row + 1)->setRowHeight($rowHeight);
        $this->sheet->getRowDimension($row + 2)->setRowHeight($rowHeight);
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç —Ñ—É—Ç–µ—Ä —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –∫–æ–º–ø–∞–Ω–∏–∏
     */
    private function fillFooter(int $startRow): void {
        $row = $startRow;

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        $this->sheet->setCellValue("A{$row}", '–ö–∞—Ä—Ç–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –û–û–û ¬´–ò–Ω–ü—Ä–æ–¥–∞–∫—à–Ω¬ª');
        $this->sheet->mergeCells("A{$row}:H{$row}");
        $this->sheet->getStyle("A{$row}")->getFont()->setBold(true)->setSize(12);
        $this->sheet->getStyle("A{$row}")->getAlignment()->setHorizontal(Alignment::HORIZONTAL_CENTER);
        $row++;

        // –†–µ–∫–≤–∏–∑–∏—Ç—ã
        $requisites = [
            ['–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏(–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —É—á—Ä–µ–¥–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏)', '–û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é ¬´–ò–Ω–ü—Ä–æ–¥–∞–∫—à–Ω¬ª'],
            ['–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–û–û–û ¬´–ò–Ω–ü—Ä–æ–¥–∞–∫—à–Ω¬ª'],
            ['–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä', '–í–∞–≥–∏–Ω –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω –ï–≤–≥–µ–Ω—å–µ–≤–∏—á'],
            ['–î–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏', '–£—Å—Ç–∞–≤'],
            ['–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å', '620085 –°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –≥.–æ. –≥–æ—Ä–æ–¥ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, —É–ª. 8 –ú–∞—Ä—Ç–∞, –¥. 267, –ø–æ–º–µ—â. 11/1'],
            ['–ò–ù–ù', '6671026720'],
            ['–ö–ü–ü', '667901001'],
            ['–†–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç', '40702810900810005883'],
            ['–ë–∞–Ω–∫', '–§–∏–ª–∏–∞–ª "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π" –ë–∞–Ω–∫–∞ –í–¢–ë (–ü–ê–û)'],
            ['–ö–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á–µ—Ç', '30101810145250000000'],
            ['–ë–ò–ö', '44525411'],
            ['–û–ö–ü–û', '44138067'],
            ['–û–ö–í–≠–î', '27.40, 32.99, 46.15.3, 46.43.1, 46.47.2, 47.59'],
            ['–û–ì–†–ù', '1156658089587'],
            ['–¢–µ–ª–µ—Ñ–æ–Ω', '+7(343) 344-44-00; 8(800)222-71-10'],
            ['–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞', 'info@in-prod.ru; info@geniled.ru'],
            ['–ê–±–æ–Ω–µ–Ω—Ç—Å–∫–∏–π —è—â–∏–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü–∏–∏', '620016, –≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –∞/—è 155'],
        ];

        foreach ($requisites as $item) {
            $this->sheet->setCellValue("A{$row}", $item[0]);
            $this->sheet->setCellValue("D{$row}", $item[1]);
            $this->sheet->mergeCells("D{$row}:H{$row}");

            $this->sheet->getStyle("A{$row}")->getFont()->setSize(9);
            $this->sheet->getStyle("D{$row}")->getFont()->setSize(9);
            $this->sheet->getStyle("A{$row}")->getAlignment()->setWrapText(true);
            $this->sheet->getStyle("D{$row}")->getAlignment()->setWrapText(true);

            $row++;
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏ –æ—Ç–¥–∞—ë—Ç —Ñ–∞–π–ª
     */
    private function save(array $kpInfo): void {
        $customerName = ($kpInfo['customer'] ?? '') ? preg_replace('~[^-_0-9–∞-—èa-z ]~ui', '', $kpInfo['customer']) : 'client';
        $filename = 'KP_' . $customerName . '_' . date('Ymd_His') . '.xlsx';
        $filepath = TEMP_DIR . $filename;

        $writer = IOFactory::createWriter($this->spreadsheet, 'Xlsx');
        $writer->save($filepath);

        // –û—Ç–¥–∞—ë–º —Ñ–∞–π–ª
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header('Content-Disposition: attachment; filename="' . $filename . '"');
        header('Cache-Control: max-age=0');
        readfile($filepath);

        // –û—á–∏—Å—Ç–∫–∞
        @unlink($filepath);
        foreach (glob(TEMP_DIR . 'img_*.*') as $f) {
            @unlink($f);
        }
        $this->spreadsheet->disconnectWorksheets();
        unset($this->spreadsheet);
    }
}
